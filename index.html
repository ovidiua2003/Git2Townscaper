<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Git2Townscaper</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="format-detection" content="telephone=no">
		<meta property="og:title" content="Git2Townscaper">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://ovidiua2003.github.io/Git2Townscaper/">
		<meta property="og:image" content="https://ovidiua2003.github.io/Git2Townscaper/git2townscaper.png">
		<meta property="og:description" content="Git2Townscaper is meant to convert github activity into Townscaper houses using activity level converted to colored building blocks.">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<link rel="icon" type="image/svg+xml" href="https://github.githubassets.com/favicons/favicon.svg">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
		<script src="https://cdn.jsdelivr.net/npm/require-stub@2.2.4/index.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/townsclipper@0.2.0/lib/index.min.js"></script>
		<style>
			body {
				background-color: #efefef;
			}
			input {
				font-size: 0.9rem !important;
			}
		</style>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-YEK1T519XG"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-YEK1T519XG');
		</script>
	</head>
	<body>
        <a href="https://github.com/ovidiua2003/Git2Townscaper" target="_blank" class="github-corner fixed-top" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></a>

        <div class="container">
			<div class="row justify-content-center mt-5 pt-5 mt-md-0">
				<div class="col-lg-6 col-md-8">
					<h1 class="mt-4"><a href="https://github.com" target="_blank">Github Activity</a> to <a href="https://www.townscapergame.com/" target="_blank">Townscaper</a></h1>
					<p>Git2Townscaper is meant to convert a github profile activity graph into Townscaper houses using the graph levels of activity for coloring. Because Townscaper is limited in how many blocks you can build horizontally, the scripts turns the graph from a day-by-day activity to a month activity, and the height of the buildings represent the level of activity summed up for that month. Currently it only takes what Github shows by default on your profile (no year selection).</p>
					<div class="mb-4">
						<label for="gitUser" class="form-label">Github Username</label>
						<input type="url" class="form-control" id="gitUser" aria-describedby="gitHelp" value="">
						<div id="gitHelp" class="form-text">Paste Github profile name (not URL) to fetch content from</div>

						<div class="mb-3">
						  <label for="gitToken" class="form-label">GitHub Token <small>(optional)</small></label>
						  <input type="password" class="form-control" id="gitToken" placeholder="ghp_...">
						</div>
						<div class="form-check mt-2">
						  <input class="form-check-input" type="checkbox" value="" id="rememberToken">
						  <label class="form-check-label" for="rememberToken">
						    Remember my token
						  </label>
						</div>
						<button id="fetchData" type="button" class="btn btn-primary mt-2">Fetch</button>
					</div>
					<div class="mb-4">
						<div class="fetchResult"></div>
					</div>
				</div>
			</div>

			<div class="row justify-content-center">
				<div class="col-lg-6 col-md-8">
					<div id="grid"></div>
					<div class="mt-2 form-check">
						<input type="checkbox" class="form-check-input" id="fillGaps" value="1">
						<label class="form-check-label" for="fillGaps" title="Fills empty blocks with white wall">Fill gaps on walls</label>
					</div>
					<div class="mt-2 form-check">
						<input type="checkbox" class="form-check-input" id="removeGaps" value="1">
						<label class="form-check-label" for="removeGaps" title="Removes all empty blocks after full green row">Remove gaps on ground</label>
					</div>
					<div class="mt-2">
						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<button id="generateTownscaper" class="btn btn-primary" type="button" disabled>Generate</button>
							</div>
							<input id="codeDisplay" type="text" class="form-control" value="" readonly="readonly">
						</div>
						<div class="mt-2 mb-4">
							<a id="townscaperLink" href="https://oskarstalberg.com/Townscaper/#F" target="_blank">oskarstalberg.com/Townscaper</a>
						</div>
					</div>
					<div class="mt-3">
					  <button id="saveBuild" class="btn btn-outline-secondary me-2">ðŸ’¾ Save Build</button>
					  <button id="loadBuild" class="btn btn-outline-secondary">ðŸ“¤ Load Build</button>
					</div>
				</div>
			</div>
      </div>

      <script type="text/javascript">
			let $days = null;
			let MAX_COLS = 12;
			let MAX_ROWS = 0;
			let $grid = null;

			window.addEventListener('DOMContentLoaded', () => {
				const savedToken = localStorage.getItem('githubToken');
				if (savedToken) {
					document.querySelector('#gitToken').value = savedToken;
					document.querySelector('#rememberToken').checked = true;
				}
			});

			// Hook into checkbox + token input
			document.querySelector('#gitToken').addEventListener('input', () => {
				const token = document.querySelector('#gitToken').value.trim();
				const remember = document.querySelector('#rememberToken').checked;

				if (remember && token) {
					localStorage.setItem('githubToken', token);
				}
			});

			document.querySelector('#rememberToken').addEventListener('change', () => {
				const token = document.querySelector('#gitToken').value.trim();
				const remember = document.querySelector('#rememberToken').checked;

				if (remember && token) {
					localStorage.setItem('githubToken', token);
				} else {
					localStorage.removeItem('githubToken');
				}
			});

			async function fetchGraphQLContributions(username, token) {
				const query = `
				query {
				  user(login: "${username}") {
				    contributionsCollection {
				      contributionCalendar {
				        weeks {
				          contributionDays {
				            date
				            contributionCount
				          }
				        }
				      }
				    }
				  }
				}`;

				const res = await fetch("https://api.github.com/graphql", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						Authorization: `Bearer ${token}`
					},
					body: JSON.stringify({ query })
				});

				const data = await res.json();

				if (!data.data?.user?.contributionsCollection?.contributionCalendar) {
					throw new Error("No contribution data found");
				}

				const days = data.data.user.contributionsCollection.contributionCalendar.weeks
					.flatMap(week => week.contributionDays);

				return days.map(day => ({
					dataset: {
						date: day.date,
						count: day.contributionCount,
						level: String(levelForCommits(day.contributionCount))
					}
				}));
			}

			document.querySelector('#fetchData').addEventListener('click', async function () {
				const gitUser = document.querySelector('#gitUser').value.trim();
				const gitToken = document.querySelector('#gitToken')?.value.trim();
				const resDiv = document.querySelector('.fetchResult');
				const fetchBtn = document.getElementById('fetchData');

				if (!gitUser || !gitToken) {
					alert("Please enter both GitHub username and token.");
					return;
				}

				fetchBtn.disabled = true;
				resDiv.innerHTML = `<div class="text-center my-3">
					<div class="spinner-border text-primary" role="status"></div>
					<p class="mt-2">Fetching year-long activity from GitHub GraphQL API...</p>
				</div>`;

				try {
					const days = await fetchGraphQLContributions(gitUser, gitToken);
					$grid = parseGrid(days);
					console.log($grid);
					MAX_ROWS = Math.max(...$grid);
					resDiv.innerHTML = `<p class="text-success">Year-long data loaded successfully!</p>`;
					document.getElementById('generateTownscaper').disabled = false;
				} catch (err) {
					console.error(err);
					resDiv.innerHTML = `<p class="text-danger">Failed to load contribution data.</p>`;
				}

				fetchBtn.disabled = false;
			});


			document.querySelector('#generateTownscaper').addEventListener('click', function () {
		    const FILL_GAPS = !!document.querySelector('#fillGaps:checked');
		    const REMOVE_GAPS = !!document.querySelector('#removeGaps:checked');

		    let sparse = [];
		    let xSpacing = 9;
		    let ySpacing = -9;
		    let maxAllowedHeight = 50;

		    let flatValues = $grid.flat();
		    let maxActivity = Math.max(...flatValues);

		    for (let month = 0; month < $grid.length; month++) {
		      for (let week = 0; week < $grid[month].length; week++) {
		        const raw = $grid[month][week];
		        if (!raw) continue;

		        const height = Math.min(Math.ceil((raw / maxActivity) * maxAllowedHeight), 255);
		        const color = colorForLevel(raw);

		        const x = xSpacing * (month + 1);
		        const y = ySpacing * (week + 1);

		        let building = sparse.find(b => b.x === x && b.y === y);
		        if (!building) {
		          building = { x, y, voxels: { 0: 15 } };
		          sparse.push(building);
		        }

		        for (let z = 1; z <= height; z++) {
		          building.voxels[z] = color;
		        }
		      }
		    }

		    let code = sparseToClip(sparse);
		    document.querySelector('#codeDisplay').value = code;
		    document.querySelector('#townscaperLink').innerText = 'oskarstalberg.com/Townscaper/#' + code.slice(0, 12) + '...';
		    document.querySelector('#townscaperLink').setAttribute('href', 'https://oskarstalberg.com/Townscaper/#' + code);
		  });

			document.querySelector('#saveBuild').addEventListener('click', () => {
				localStorage.setItem('git2townscaper_code', document.querySelector('#codeDisplay').value);
				alert('Build saved locally!');
			});

			document.querySelector('#loadBuild').addEventListener('click', () => {
				const code = localStorage.getItem('git2townscaper_code');
				if (code) {
					document.querySelector('#codeDisplay').value = code;
					document.querySelector('#townscaperLink').innerText = 'oskarstalberg.com/Townscaper/#' + code;
					document.querySelector('#townscaperLink').href = 'https://oskarstalberg.com/Townscaper/#' + code;
					alert('Build loaded!');
				} else {
					alert('No saved build found.');
				}
			});

			function colorForLevel(level) {
				if (level >= 200) return 2;   // very high
				if (level >= 100) return 3;   // high
				if (level >= 50) return 5;    // medium
				if (level >= 10) return 7;    // low
				return 14;                    // very low / inactive
			}

			function groupEventsByDay(events) {
			  const counts = {};

			  events.forEach(event => {
			    const day = event.created_at.split('T')[0]; // e.g., "2025-04-01"
			    counts[day] = (counts[day] || 0) + 1;
			  });

			  return counts;
			}

			function levelForCommits(count) {
			  // Define your own logic for levels (0â€“4)
			  if (count >= 12) return 4;
			  if (count >= 8) return 3;
			  if (count >= 4) return 2;
			  if (count >= 1) return 1;
			  return 0;
			}

			function convertToParseGridInput(groupedByDay) {
			  return Object.entries(groupedByDay).map(([date, count]) => ({
			    dataset: {
			      date,
			      count,
			      level: String(levelForCommits(count)),
			    }
			  }));
			}

			function parseGrid(days) {
		    const grid = Array.from({ length: 12 }, () => Array(6).fill(0)); // 12 months x up to 6 weeks
		    days.forEach(day => {
		      const d = new Date(day.dataset.date);
		      const month = d.getMonth();
		      const week = Math.floor(d.getDate() / 7);
		      grid[month][week] += parseInt(day.dataset.count);
		    });
		    return grid;
		  }

			function sleep(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
			}
        </script>
    </body>
</html>