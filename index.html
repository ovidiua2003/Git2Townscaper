<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Git2Townscaper</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="format-detection" content="telephone=no">
		<meta property="og:title" content="Git2Townscaper">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://ovidiua2003.github.io/Git2Townscaper/">
		<meta property="og:image" content="https://ovidiua2003.github.io/Git2Townscaper/git2townscaper.png">
		<meta property="og:description" content="Git2Townscaper is meant to convert github activity into Townscaper houses using activity level converted to colored building blocks.">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<link rel="icon" type="image/svg+xml" href="https://github.githubassets.com/favicons/favicon.svg">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
		<script src="https://cdn.jsdelivr.net/npm/require-stub@2.2.4/index.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/townsclipper@0.2.0/lib/index.min.js"></script>
		<style>
			body {
				background-color: #efefef;
			}
			input {
				font-size: 0.9rem !important;
			}
		</style>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-YEK1T519XG"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-YEK1T519XG');
		</script>
	</head>
	<body>
        <a href="https://github.com/ovidiua2003/Git2Townscaper" target="_blank" class="github-corner fixed-top" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></a>

        <div class="container">
			<div class="row justify-content-center mt-5 pt-5 mt-md-0">
				<div class="col-lg-6 col-md-8">
					<h1 class="mt-4"><a href="https://github.com" target="_blank">Github Activity</a> to <a href="https://www.townscapergame.com/" target="_blank">Townscaper</a></h1>
					<div class="mb-4">
						<label for="gitUser" class="form-label">Github Username</label>
						<input type="url" class="form-control" id="gitUser" aria-describedby="gitHelp" value="">
						<div id="gitHelp" class="form-text">Paste Github profile name (not URL) to fetch content from</div>
						<button id="fetchData" type="button" class="btn btn-primary mt-2">Fetch</button>
					</div>
					<div class="mb-4">
						<div class="fetchResult"></div>
					</div>
				</div>
			</div>

			<div class="row justify-content-center">
				<div class="col-lg-6 col-md-8">
					<div id="grid"></div>
					<div class="mt-2 form-check">
						<input type="checkbox" class="form-check-input" id="fillGaps" value="1">
						<label class="form-check-label" for="fillGaps" title="Fills empty blocks with white wall">Fill gaps on walls</label>
					</div>
					<div class="mt-2 form-check">
						<input type="checkbox" class="form-check-input" id="removeGaps" value="1">
						<label class="form-check-label" for="removeGaps" title="Removes all empty blocks after full green row">Remove gaps on ground</label>
					</div>
					<div class="mt-2">
						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<button id="generateTownscaper" class="btn btn-primary" type="button" disabled>Generate</button>
							</div>
							<input id="codeDisplay" type="text" class="form-control" value="" readonly="readonly">
						</div>
						<div class="mt-2 mb-4">
							<a id="townscaperLink" href="https://oskarstalberg.com/Townscaper/#F" target="_blank">oskarstalberg.com/Townscaper</a>
						</div>
					</div>
				</div>
			</div>
        </div>

        <script type="text/javascript">
			let $days = null;
			let MAX_COLS = 12;
			let MAX_ROWS = 0;
			let $grid = null;

			document.querySelector('#fetchData').addEventListener('click', function() {
				let gitUser = document.querySelector('#gitUser').value.trim();
				let resDiv = document.querySelector('.fetchResult');

				document.getElementById('generateTownscaper').disabled = true;

				if (gitUser) {
					if (typeof gtag === 'function') {
						gtag('event', 'click', {
							'event_category' : 'button',
							'event_label' : 'fetchData',
							'value': 1
						});
					}
					document.querySelector('.fetchResult').innerHTML = '';
					let url = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://github.com/' + gitUser);
					fetch(url).then(response => {
						return response.json();
					})
					.then(data => {
						if (data.status && data.status.http_code == 200) return data;
						resDiv.innerHTML = '<p class="text-error">No parsable data returned. Please check that the github profile actually has activity.</p>';
						throw new Error('No parsable data returned.');
					})
					.then(data => {
						const parser = new DOMParser();
						const $newDoc = parser.parseFromString(data.contents, 'text/html');
						$days = $newDoc.querySelectorAll('svg.js-calendar-graph-svg rect.ContributionCalendar-day');
						if ($days.length == 0) {
							resDiv.innerHTML = '<p class="text-error">No parsable data returned. Please check that the github profile actually has activity.</p>';
							return;
						}
						resDiv.innerHTML = '<p class="text-success">Data found. Click the Generate Button!</p>';
						$grid = parseGrid($days);
						MAX_ROWS = Math.max(...$grid);

						document.getElementById('generateTownscaper').disabled = false;
					}).catch(message => alert);
				}
				else {
					if (typeof gtag === 'function') {
						gtag('event', 'click', {
							'event_category' : 'button',
							'event_label' : 'fetchData',
							'value': 0
						});
					}
					alert('Not value entered');
				}
			});

			document.querySelector('#generateTownscaper').addEventListener('click', function() {
				if (typeof gtag === 'function') {
					gtag('event', 'click', {
						'event_category' : 'button',
						'event_label' : 'generateTownscaper'
					});
				}
				const FILL_GAPS = !!document.querySelector('#fillGaps:checked');
				const REMOVE_GAPS = !!document.querySelector('#removeGaps:checked');
				let buildingBlocks = [];
				let successCount = [];
				let sparse = [];
				let x = 9;
				let y = -9;
				for (let z=0; z<MAX_COLS; z++) {
					sparse[z] = {'x':x*(z+1), 'y':y, 'voxels':{0:15}};
				}
				for (let i=0; i<$grid.length; i++) {
					let floor = MAX_ROWS-parseInt(i/MAX_COLS);
					if (parseInt($grid[i]) == MAX_COLS) {
						if (!successCount[floor]) {
							successCount[floor] = 1;
						}
						else {
							successCount[floor]++;
						}
					}
					buildingBlocks.push($grid[i]);
					if (REMOVE_GAPS && successCount[floor] && successCount[floor] == MAX_COLS) {
						break;
					}
				};

				for (let i=0; i<buildingBlocks.length; i++) {
					let z = i % MAX_COLS;
					let floor = parseInt(buildingBlocks.length/MAX_COLS)-parseInt(i/MAX_COLS);
					let color = parseInt(buildingBlocks[i]) > 14 ? 14 : parseInt(buildingBlocks[i]);
					if (!sparse[z]) {
						sparse[z] = {'x':x*(z+1), 'y':y, 'voxels':{}};
					}
					if (!color) {
						if (FILL_GAPS) {
							if (!floor) {
								sparse[z]['voxels'][floor] = 15;
							}
							else {
								sparse[z]['voxels'][floor] = 14;
							}
						}
					}
					else {
						for (let j = 1; j <= buildingBlocks[i]; j++) {
							sparse[z]['voxels'][j] = !j ? 15 : color;
						}
					}
				}
				let code = sparseToClip(sparse);
				document.querySelector('#codeDisplay').value = code;
				document.querySelector('#townscaperLink').innerText = 'oskarstalberg.com/Townscaper/#' + code;
				document.querySelector('#townscaperLink').setAttribute('href', 'https://oskarstalberg.com/Townscaper/#' + code);
			});

			function parseGrid(days)
			{
				let out = [0,0,0,0,0,0,0,0,0,0,0,0];
				days.forEach((day, index) => {
					let d = new Date(day.dataset.date);
					out[parseInt(d.getMonth())] += parseInt(day.dataset.level);
				});

				return out;
			}
        </script>
    </body>
</html>